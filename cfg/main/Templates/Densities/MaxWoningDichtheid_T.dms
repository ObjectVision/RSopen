Template MaxWoningDichtheid_T
{
	//
	parameter<Classifications/Vastgoed/WP2xVSSH> id;
	attribute<bool> IsWoonlocatie (AllocDomain);
	//
	
	parameter<string> name_short := Classifications/Vastgoed/WP2/name_short[Classifications/Vastgoed/WP2xVSSH/first_rel[id]];
	
	parameter<Woning_ha> MinimumUitMinimumOP := = 'min(/VariantParameters/Ontwikkelpakketten/'+VariantParameters/VariantK/OntwikkelPakketVariant[Variant_rel]+'/perWP2xVSSH/'+Classifications/Vastgoed/WP2xVSSH/name[id]+'/OP_sub/Dichtheid)';
	parameter<Woning_ha> MinimumDichtheid    := = '/VariantParameters/VariantK/MinimumDichtheid_'+name_short+'_'+/Scenario_name+'[/VariantParameters/VariantK/V/'+/Variant_name+']';
	parameter<Woning_ha> Minimum  := max_elem(MinimumUitMinimumOP, MinimumDichtheid);
	// parameter<Woning_ha> Minimum  := MinimumUitMinimumOP;
	
	parameter<float32> DichtheidFActorOV              := = 'CaseClassifications/VariantK/DichtheidFActorOV_'+name_short+'[0b]';
	parameter<float32> DichtheidFActorWater           := = 'CaseClassifications/VariantK/DichtheidFActorWater_'+name_short+'[0b]';
	parameter<float32> DichtheidFActorGeneriek        := = 'CaseClassifications/VariantK/DichtheidFActorGeneriek'+'[0b]';
	parameter<float32> DichtheidFActorBevKern100kPlus := = 'CaseClassifications/VariantK/DichtheidFActorBevKern100kPlus_'+name_short+/Scenario_name+'[0b]';
	parameter<float32> DichtheidFActorBevKern20kPlus  := = 'CaseClassifications/VariantK/DichtheidFActorBevKern20kPlus_'+name_short+/Scenario_name+'[0b]';
	parameter<float32> DichtheidFActorBevKern20kMin   := = 'CaseClassifications/VariantK/DichtheidFActorBevKern20kMin_'+name_short+/Scenario_name+'[0b]';
	
	attribute<float32> DichtheidFActor (AllocDomain) := add(
		float32(BaseData/Omgeving/OV_Reistijd/TotRailHalte/Smoothed)            * (DichtheidFActorOV - 1f),
		float32(BaseData/StartState/Grondgebruik/NabijGrootWaterInBBG/Smoothed) * (DichtheidFActorWater - 1f),
		switch(
			case(BaseData/Omgeving/RondBevolkingskern/Is100kPlus, float32(BaseData/Omgeving/RondBevolkingskern/Is100kPlus) * (DichtheidFActorBevKern100kPlus - 1f)),
			case(BaseData/Omgeving/RondBevolkingskern/Is20kPlus,  float32(BaseData/Omgeving/RondBevolkingskern/Is20kPlus)  * (DichtheidFActorBevKern20kPlus - 1f)),
			case(BaseData/Omgeving/RondBevolkingskern/Is20kMin,   float32(BaseData/Omgeving/RondBevolkingskern/Is20kMin)   * (DichtheidFActorBevKern20kMin - 1f)),
			const(0f, AllocDomain)
		),
		DichtheidFActorGeneriek - 1f,
		1f
	);
	
	attribute<Woning>    Src                   (CompactedAdminDomain) := BaseData/StartState/StateBasisjaar/Src0/Wonen/WP1s/Totaal;
	attribute<Woning_ha> Dichtheid_AllocDomain (AllocDomain) := sum(Src, CompactedAdminDomain/AllocDomain_rel) / (float32(IsWoonlocatie) * AllocDomain/NrHaPerCell);
	attribute<Woning_ha> Dichtheid_Buurt       (AllocDomain) := ='mean(Dichtheid_AllocDomain, RegioIndelingen/cbs/Y'+string(ModelParameters/Model_StartYear)+'/buurt/Per_AllocDomain)[RegioIndelingen/cbs/Y'+string(ModelParameters/Model_StartYear)+'/Buurt/Per_AllocDomain]';
	attribute<Woning_ha> Dichtheid_Wijk        (AllocDomain) := ='mean(Dichtheid_AllocDomain, RegioIndelingen/cbs/Y'+string(ModelParameters/Model_StartYear)+'/Wijk/Per_AllocDomain)[RegioIndelingen/cbs/Y'+string(ModelParameters/Model_StartYear)+'/Wijk/Per_AllocDomain]';
	attribute<Woning_ha> Dichtheid_Gemeente    (AllocDomain) := ='mean(Dichtheid_AllocDomain, RegioIndelingen/cbs/Y'+string(ModelParameters/Model_StartYear)+'/Gemeente/Per_AllocDomain)[RegioIndelingen/cbs/Y'+string(ModelParameters/Model_StartYear)+'/Gemeente/Per_AllocDomain]';
	attribute<Woning_ha> Dichtheid_NVM         (AllocDomain) := ='mean(Dichtheid_AllocDomain, RegioIndelingen/NVM/Per_AllocDomain)[RegioIndelingen/NVM/Per_AllocDomain]';
	attribute<Woning_ha> Dichtheid_COROP       (AllocDomain) := ='mean(Dichtheid_AllocDomain, RegioIndelingen/cbs/Y'+string(ModelParameters/Model_StartYear)+'/COROP/Per_AllocDomain)[RegioIndelingen/cbs/Y'+string(ModelParameters/Model_StartYear)+'/COROP/Per_AllocDomain]';
	attribute<Woning_ha> Dichtheid_Provincie   (AllocDomain) := ='mean(Dichtheid_AllocDomain, RegioIndelingen/cbs/Y'+string(ModelParameters/Model_StartYear)+'/Provincie/Per_AllocDomain)[RegioIndelingen/cbs/Y'+string(ModelParameters/Model_StartYear)+'/Provincie/Per_AllocDomain]';
	attribute<Woning_ha> Max                   (AllocDomain) := max_elem(Dichtheid_AllocDomain, Dichtheid_Buurt, Dichtheid_Wijk, Dichtheid_Gemeente, Dichtheid_NVM, Dichtheid_COROP, Dichtheid_Provincie);
	attribute<Woning_ha> MaalFActor            (AllocDomain) := Max * DichtheidFActor;
	attribute<Woning_ha> ResultMaalFActor      (AllocDomain) := value(potential(MaalFActor, Geography/Distmatrices_100m/pot2000m/rev_dist_scaled / sum(Geography/Distmatrices_100m/pot2000m/rev_dist_scaled)), Woning_ha);
	attribute<Woning_ha> ResultNietMaalFActor  (AllocDomain) := value(potential(Max, Geography/Distmatrices_100m/pot2000m/rev_dist_scaled / sum(Geography/Distmatrices_100m/pot2000m/rev_dist_scaled)), Woning_ha);
	attribute<Woning_ha> Result                (AllocDomain) := Max_elem(ResultMaalFActor, Minimum);
}