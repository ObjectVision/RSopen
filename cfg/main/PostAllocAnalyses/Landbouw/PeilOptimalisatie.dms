////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//
// Dit is RSOpen, de open source versie van het model RuimteScanner. Het scipt wordt uitgegeven onder GNU-GPL licentie.
//
// RSOpen is ontwikkeld door PBL Planbureau voor de Leefomgeving, i.s.m Object Vision B.V. en VU Vrije Universiteit Amsterdam.
// Opdrachtgever/ontwikkelaar PBL: Bart Rijken
// Contactpersoon/ontwikkelaar Object Vision B.V.: Jip Claassens (jclaassens@objectvision.nl)
// Contacpersoon PBL: Bas van Bemmel (Bas.vanBemmel@pbl.nl)
//
// Deze file bevat de bronData (SourceData) die het model nodig heeft voor de verschillende berekeningen/analyses.De Data worden ingelezen vanuit de SourceRVF_DataDir.
// De bronnen zijn divers. Tenzij anders aangegeven is dat het PBL.
//
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

container PeilOptimalisatie: using = "Classifications;Classifications/Vastgoed;Classifications/Landbouw;Classifications/Actor;Classifications/Time;units;Geography"
{
	// To do nu:
		// checken waarom hogere npv landbouw in wbs dan in bau
		// Resulatten aggregeren naar tabel, in logische combinaties, voor presentatie
		
	// TODO later
		// Co2 emiussie lokaal afkappen obv dikte veenpakket of (beter) hoeveenheid co2 in ondergrond
		// Checken of de vooronderstellingen qua slootwaterpeil en griondweaterstand consistent zijn in bau en wbs (comsistent tussen CO2emissie berekening en opbrengstenderving bertekening van agrarisch landuse)
	
	container Impl := /PostAllocAnalyses/Landbouw/Impl
	{
		unit<uint32> ZichtjaarXEmissieXPrijsK := combine(ZichtjaarK, CO2/EmissieXPrijsK)
		{
			attribute<string> Zichtjaar_name := ZichtjaarK/name[first_rel];
			attribute<string> EmissieXPrijs_name := CO2/EmissieXPrijsK/name[second_rel];
			attribute<string> Emissie_name := CO2/EmissieXPrijsK/Emissie_name[second_rel];
			attribute<string> Prijs_name := CO2/EmissieXPrijsK/Prijs_name[second_rel];
			attribute<string> name := Zichtjaar_name+'/'+Emissie_name+'/'+Prijs_name;
		}
		
		container OntkoppelRelevantOutputFiles // de relevante te ontkoppelen data, per casus, per boervariant, per zichtjaar
		{
			// parameter<string> Landgebruikskaart_basisjaar  := 'Ready', ExplicitSuppliers = "Indicatoren/Basisjaar/Landgebruikskaart/Write_Result_SA"; // gebruiken we deze hier?
			// parameter<string> Landgebruikskaart_Zichtjaar  := 'Ready', ExplicitSuppliers = "=AsList('Indicatoren/'+ZichtjaarK/name+'/Landgebruikskaart/Write_Result_SA', ';')";
			// parameter<string> NPVGrondgebruik              := 'Ready', ExplicitSuppliers = "=AsList('Indicatoren/Export/Impl/Zichtjaren/'+ZichtjaarK/name+'/NPV_perLUMT/Totaal', ';')";
			parameter<string> NPVCO2Emissie                := 'Ready', ExplicitSuppliers = "=AsList('Indicatoren/'+ZichtjaarXEmissieXPrijsK/Zichtjaar_name+'/SOMERS_CO2_laagveen/Kosten/'+ZichtjaarXEmissieXPrijsK/EmissieXPrijs_name+'/NPV', ';')";
		}
		
		// unit<uint32> GrondgebruikContext := combine(ScenarioK, VariantK, BoerVariantK, BeregeningScenarioK, ZichtjaarK) // Grondgebruik en de NVP ervan is afhankelijk van alles dat grondgebruik bepaalt, zowel niet-agrarisch als agrarisch
		// {
			// attribute<string> Scenario_name           := ScenarioK/name[first_rel];
			// attribute<string> Variant_name            := VariantK/name[second_rel];
			// attribute<string> Boervariant_name        := BoerVariantK/name[third_rel];
			// attribute<string> BeregeningScenario_name := BeregeningScenarioK/name[fourth_rel];
			// attribute<string> Zichtjaar_name          := ZichtjaarK/name[fifth_rel];
			// attribute<string> name                    := Scenario_name+'/'+Variant_name+'/'+Boervariant_name+'/'+BeregeningScenario_name+'/'+Zichtjaar_name;
			// attribute<string> Label                   := replace(name, '/', '_');
		// }
		
		unit<uint32> CO2KostenContext := combine(ScenarioK, VariantK, ZichtjaarK, CO2/EmissieK, CO2/PrijsK) // CO2kosten zijn afhankelijk van verstedeljking en exo water per scenario, per variant per zichtjaar en afhankeloijk van CO2 emissie en -prijs. Niet afhankelijk van agrarisch grondgebruik en (dus) niet van type boer of beregening
		{
			attribute<string> Scenario_name    := ScenarioK/name[first_rel];
			attribute<string> Variant_name     := VariantK/name[second_rel];
			attribute<string> Zichtjaar_name   := ZichtjaarK/name[third_rel];
			attribute<string> CO2Emissie_name := CO2/EmissieK/name[fourth_rel];
			attribute<string> CO2Prijs_name    := CO2/PrijsK/name[fifth_rel];
			attribute<string> name             := Scenario_name+'/'+Variant_name+'/'+Zichtjaar_name+'/'+CO2Emissie_name+'/'+CO2Prijs_name;
			attribute<string> Label            := replace(name, '/', '_');
		}
		
		unit<uint32> AggregatieContext := combine(ScenarioK, VariantK, BoerVariantK, BeregeningScenarioK, ZichtjaarK, CO2/EmissieK, CO2/PrijsK) // De aggregatie van NPV grondgebruik en NPV CO2 is afhankelijk van alles wat griondgebruik en de kosten van CO2emissies beinvloedt
		{
			attribute<string> Scenario_name           := ScenarioK/name[first_rel];
			attribute<string> Variant_name            := VariantK/name[second_rel];
			attribute<string> Boervariant_name        := BoerVariantK/name[third_rel];
			attribute<string> BeregeningScenario_name := BeregeningScenarioK/name[fourth_rel];
			attribute<string> Zichtjaar_name          := ZichtjaarK/name[fifth_rel];
			attribute<string> CO2Emissie_name         := CO2/EmissieK/name[sixth_rel];
			attribute<string> CO2Prijs_name           := CO2/PrijsK/name[seventh_rel];
			attribute<string> name                    := Scenario_name+'/'+Variant_name+'/'+Boervariant_name+'/'+BeregeningScenario_name+'/'+Zichtjaar_name+'/'+CO2Emissie_name+'/'+CO2Prijs_name;
			attribute<string> Label                   := replace(name, '/', '_');
		}
		
		unit<uint32> OptimalisatieContext := combine(ScenarioK, BoerVariantK, BeregeningScenarioK, ZichtjaarK, CO2/EmissieK, CO2/PrijsK) // De relevante onzekerheden bij de optimalisatie van de variant, over co2 en Grondgebruik heen. Klopt
		{
			attribute<string> Scenario_name           := ScenarioK/name[first_rel];
			attribute<string> Boervariant_name        := BoerVariantK/name[second_rel];
			attribute<string> BeregeningScenario_name := BeregeningScenarioK/name[third_rel];
			attribute<string> Zichtjaar_name          := ZichtjaarK/name[fourth_rel];
			attribute<string> CO2Emissie_name         := CO2/EmissieK/name[fifth_rel];
			attribute<string> CO2Prijs_name           := CO2/PrijsK/name[sixth_rel];
			attribute<string> name                    := Scenario_name+'/'+Boervariant_name+'/'+BeregeningScenario_name+'/'+Zichtjaar_name+'/'+CO2Emissie_name+'/'+CO2Prijs_name;
			attribute<string> Label                   := replace(name, '/', '_');
		}
	}
	
	// unit<uint8> VariantK := /VariantParameters/VariantK;
	// unit<uint8> ZichtjaarK := /Classifications/Time/Zichtjaar;
	// unit<uint8> GrondgebruikK := /Classifications/Actor/LU_ModelType;
	// unit<uint8> BeregeningScenarioK := /SourceData/Landbouw/Yield_Reduction/BeregeningScenarios;
	
	// container Grondgebruik :=
		// for_each_ndvat(
			// impl/GrondgebruikContext/name
			// ,AdminDomain
			// ,GrondgebruikK
			// ,'%LocalDataProjDir%/Indicatoren/Landgebruik/'+impl/GrondgebruikContext/Scenario_name+'_'+impl/GrondgebruikContext/variant_name+'/'+impl/GrondgebruikContext/Boervariant_name+'/'+impl/GrondgebruikContext/BeregeningScenario_name+'/'+impl/GrondgebruikContext/Zichtjaar_name+'/'+/ModelParameters/StudyArea+'.tif'
			// ,'gdal.grid'
		// );
	
	// container TotaalGrondgebruikPerGrondgebruikK :=
		// for_each_nedv(
			// impl/GrondgebruikContext/name,
			// 'union_data(GrondgebruikK,'+
			// replace(
				// AsItemList('sum(float32(Grondgebruik/@GC@ == GrondgebruikK/V/'+GrondgebruikK/name+') * AdminDomain/NrHaPerCell)'),
				// '@GC@', impl/GrondgebruikContext/name
			// )+')',
			// GrondgebruikK, Ha
		// );
	
	// container NPVGrondgebruik :=
		// for_each_ndvat(
			// impl/GrondgebruikContext/name
			// ,AdminDomain
			// ,EUR
			// ,'%LocalDataProjDir%/Indicatoren/NPV/'+impl/GrondgebruikContext/Scenario_name+'_'+impl/GrondgebruikContext/variant_name+'/'+impl/GrondgebruikContext/Boervariant_name+'/'+impl/GrondgebruikContext/BeregeningScenario_name+'/'+impl/GrondgebruikContext/Zichtjaar_name+'/'+/ModelParameters/StudyArea+'.tif'
			// ,'gdal.grid'
		// );
	
	// container GemiddeldeNPVGrondgebruikPerGrondgebruikK := 
		// for_each_nedv(
			// impl/GrondgebruikContext/name,
			// 'union_data(GrondgebruikK,'+
			// replace(
				// AsItemList('mean(NPVGrondgebruik/@GC@ / float32(Grondgebruik/@GC@ == GrondgebruikK/V/'+GrondgebruikK/name+') / AdminDomain/NrHaPerCell)'),
				// '@GC@', impl/GrondgebruikContext/name
			// )+')',
			// GrondgebruikK, EUR_ha
		// );
	
	container NPVCO2Emissie :=
		for_each_ndvat(
			impl/CO2KostenContext/name
			,AdminDomain
			,EUR
			,'%LocalDataProjDir%/Indicatoren/SOMERS_CO2/Kosten/'+impl/CO2KostenContext/Scenario_name+'_'+impl/CO2KostenContext/variant_name+'/'+impl/CO2KostenContext/Zichtjaar_name+'_'+/ModelParameters/StudyArea+'_'+impl/CO2KostenContext/CO2Emissie_name+'_'+impl/CO2KostenContext/CO2Prijs_name+'.tif'
			,'gdal.grid'
	);
	
	container NPVTotaal :=
		for_each_nedv(
			impl/AggregatieContext/name
			,replace(
				'NPVGrondgebruik/@S@/@V@/@B@/@B2@/@Z@ - NPVCO2Emissie/@S@/@V@/@Z@/@E@/@P@'
				,'@S@', impl/AggregatieContext/Scenario_name
				,'@V@', impl/AggregatieContext/Variant_name
				,'@B@', impl/AggregatieContext/Boervariant_name
				,'@B2@', impl/AggregatieContext/BeregeningScenario_name
				,'@Z@', impl/AggregatieContext/Zichtjaar_name
				,'@E@', impl/AggregatieContext/CO2Emissie_name
				,'@P@', impl/AggregatieContext/CO2Prijs_name
			)
			,AdminDomain,
			EUR
		);
		
	container NPVTotaalPerPeilgebied :=
		for_each_nedv(
			impl/AggregatieContext/name
			,'sum(NPVTotaal/'+impl/AggregatieContext/name+', SourceData/Landbouw/Peilgebieden/per_grid)'
			,SourceData/Landbouw/Peilgebieden
			,EUR
		);
	
	container Optima
	{
		container Variant :=
			for_each_nedv(
				impl/OptimalisatieContext/name
				,replace(
					'ArgMax('+AsItemList('NPVTotaalPerPeilgebied/@S@/'+VariantK/name+'/@B@/@B2@/@Z@/@E@/@P@')+')[VariantK]'
					,'@S@', impl/OptimalisatieContext/Scenario_name
					,'@B@', impl/OptimalisatieContext/Boervariant_name
					,'@B2@', impl/OptimalisatieContext/BeregeningScenario_name
					,'@Z@', impl/OptimalisatieContext/Zichtjaar_name
					,'@E@', impl/OptimalisatieContext/CO2Emissie_name
					,'@P@', impl/OptimalisatieContext/CO2Prijs_name
				)
				,SourceData/Landbouw/Peilgebieden
				,VariantK
			);
		
		container VariantPerGrid :=
			for_each_nedv(
				impl/OptimalisatieContext/name
				,'Variant/'+impl/OptimalisatieContext/name+'[SourceData/Landbouw/Peilgebieden/per_grid]'
				,AdminDomain
				,VariantK
			);
		
		container Grondgebruik :=
			for_each_nedv(
				impl/OptimalisatieContext/name
				,replace(
					'merge(uint16(VariantPerGrid/@O@), GrondgebruikK,'+AsItemList('PeilOptimalisatie/Grondgebruik/@S@/'+VariantK/name+'/@B@/B2/@Z@')+')'
					,'@O@', impl/OptimalisatieContext/name
					,'@S@', impl/OptimalisatieContext/Scenario_name
					,'@B@', impl/OptimalisatieContext/Boervariant_name
					,'@B2@', impl/OptimalisatieContext/BeregeningScenario_name
					,'@Z@', impl/OptimalisatieContext/Zichtjaar_name
				)
				,AdminDomain
				,GrondgebruikK
			);
		
		container NPVGrondgebruik :=
			for_each_nedv(
				impl/OptimalisatieContext/name
				,replace(
					'merge(uint16(VariantPerGrid/@O@), EUR,'+AsItemList('PeilOptimalisatie/NPVGrondgebruik/@S@/'+VariantK/name+'/@B@/@B2@/@Z@')+')'
					,'@O@', impl/OptimalisatieContext/name
					,'@S@', impl/OptimalisatieContext/Scenario_name
					,'@B@', impl/OptimalisatieContext/Boervariant_name
					,'@B2@', impl/OptimalisatieContext/BeregeningScenario_name
					,'@Z@', impl/OptimalisatieContext/Zichtjaar_name
				)
				,AdminDomain
				,EUR
			);
		
		container NPVCO2Emissie :=
			for_each_nedv(
				impl/OptimalisatieContext/name
				,replace(
					'merge(uint16(VariantPerGrid/@O@), EUR,'+AsItemList('PeilOptimalisatie/NPVCO2Emissie/@S@/'+VariantK/name+'/@Z@/@E@/@P@')+')'
					,'@O@', impl/OptimalisatieContext/name
					,'@S@', impl/OptimalisatieContext/Scenario_name
					,'@Z@', impl/OptimalisatieContext/Zichtjaar_name
					,'@E@', impl/OptimalisatieContext/CO2Emissie_name
					,'@P@', impl/OptimalisatieContext/CO2Prijs_name
				)
				,AdminDomain
				,EUR
			);
		
		container NPVTotaal :=
			for_each_nedv(
				impl/OptimalisatieContext/name
				,replace(
					'merge(uint16(VariantPerGrid/@O@), EUR,'+AsItemList('PeilOptimalisatie/NPVTotaal/@S@/'+VariantK/name+'/@B@/@B2@/@Z@/@E@/@P@')+')'
					,'@O@', impl/OptimalisatieContext/name
					,'@S@', impl/OptimalisatieContext/Scenario_name
					,'@B@', impl/OptimalisatieContext/Boervariant_name
					,'@B2@', impl/OptimalisatieContext/BeregeningScenario_name
					,'@Z@', impl/OptimalisatieContext/Zichtjaar_name
					,'@E@', impl/OptimalisatieContext/CO2Emissie_name
					,'@P@', impl/OptimalisatieContext/CO2Prijs_name
				)
				,AdminDomain
				,EUR
			);
	}
}